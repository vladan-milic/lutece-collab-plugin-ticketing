<#include "/admin/plugins/ticketing/commons.html" />
<#macro sortColumn field=''>
    <i class="fa fa-chevron-up" onclick="sortList('${field}','asc')"></i>&nbsp;<i class="fa fa-chevron-down" onclick="sortList('${field}','desc')"></i>
</#macro>

<#macro renderTabPanel panel_list active=false id=''>
	<div role="tabpanel" class="tab-pane <#if active> active</#if>" <#if id!="">id="${id}"</#if> >
		<input type="hidden" id="id" name="id">
    <div class="row">
      <div class="col-xs-12 col-sm-offset-1 col-sm-10 table-responsive">
      <#if panel_list?? && panel_list?has_content>
  	    <table class="table table-hover table-striped">
      		<thead>
      		  <tr>
              <!--
      			<th>#i18n{ticketing.manage_tickets.columnReference} <@sortColumn field='reference'/></th>
      			<th>#i18n{ticketing.manage_tickets.columnOpenPeriod} <@sortColumn field='date_create'/></th>
      			<th>#i18n{ticketing.manage_tickets.columnTicketType} <@sortColumn field='category_label'/></th>
      			<th>#i18n{ticketing.manage_tickets.columnUser} / #i18n{ticketing.manage_tickets.columnTicketComment} <@sortColumn field='lastname'/></th>
      			<th>#i18n{ticketing.manage_tickets.columnTicketState} <@sortColumn field='state'/></th>
      			<th>Assignation <@sortColumn field='assignee'/></th>
          -->
              <th data-field="reference">#i18n{ticketing.manage_tickets.columnReference} </th>
        			<th data-field="date_create">#i18n{ticketing.manage_tickets.columnDateCreate}</th>
        			<th data-field="category_label">#i18n{ticketing.manage_tickets.columnTicketType}</th>
        			<th data-field="lastname">#i18n{ticketing.manage_tickets.columnUser} / #i18n{ticketing.manage_tickets.columnTicketComment}</th>
        			<th data-field="state">#i18n{ticketing.manage_tickets.columnTicketState}</th>
        			<th data-field="assignee"><!-- #i18n{ticketing.manage_tickets.columnTicketAssignee}--> Assignation </th>
      		  </tr>
      	  </thead>
      		<tbody>
    			<#list panel_list as ticket >
    			<tr data-url="jsp/admin/plugins/ticketing/TicketView.jsp?id=${ticket.id}">
    			  <td>
              <#assign textColor="aqua"/>
              <#if ticket.urgency==1 >
                <#assign textColor="orange"/>
              <#elseif ticket.urgency==2 >
                <#assign textColor="red"/>
              </#if>
              <#switch ticket.criticality>
              <#case 1>
                <#assign criticality="Mod&eacute;r&eacute;"/>
                <#break>
              <#case 2>
                <#assign criticality="Elev&eacute;e"/>
                <#break>
              <#default>
                <#assign criticality="Faible"/>
            </#switch>
            <#switch ticket.priority>
              <#case 1>
                <#assign priority="Moyenne"/>
                <#break>
              <#case 2>
                <#assign priority="Urgente"/>
                <#break>
              <#default>
                <#assign priority="Basse"/>
            </#switch>
              <#if ticket.reference??>
                <a href="jsp/admin/plugins/ticketing/TicketView.jsp?id=${ticket.id}" data-toggle="tooltip" data-placement="bottom" title="Criticit&eacute;:  ${criticality!''} / Priorit&eacute;: ${priority!''}" >
                  <i class="fa fa-circle text-${textColor}" ></i> ${ticket.reference}
                </a>
              <#else>
                <a data-toggle="tooltip" data-placement="bottom" href="jsp/admin/plugins/ticketing/TicketView.jsp?id=${ticket.id}" title="Criticit&eacute;: ${criticality!''} / Priorit&eacute;: ${priority!''}">
                  <i class="fa fa-circle text-${textColor}" ></i> ${ticket.id}
                </a>
              </#if>
            </td>
		          <td>
    				${ticket.dateCreate?string["dd/MM/yyyy HH:mm"]}
    			  </td>
    			  <td>
    				  ${ticket.ticketType} <br>Domaine: ${ticket.ticketDomain} <br>Cat&eacute;gorie: <strong>${ticket.ticketCategory}</strong>
    			  </td>
    			  <td >
    				<!-- <p class="text-left"> -->
    				<p>
    				  <strong>${ticket.userTitle} ${ticket.firstname} ${ticket.lastname}</strong>
            </p>
            <!-- <p class="text-left"> -->
            <p>
    				<#if ticket.email ??>
    				  <small>
    					  <i class="fa fa-envelope"></i> ${ticket.email}
    				  </small>
    				</#if>
    				<#if ticket.mobilePhoneNumber ?? && ticket.mobilePhoneNumber?length &gt; 1 >
    				  <small>
    					  / <i class="fa fa-mobile-phone"></i> ${ticket.mobilePhoneNumber}
    				  </small>
    				</#if>
    				<#if ticket.fixedPhoneNumber ?? && ticket.fixedPhoneNumber?length &gt; 1>
    				  <small>
    					  / <i class="fa fa-phone"></i> ${ticket.fixedPhoneNumber}
    				  </small>
    				</#if>
    				</p>
            <#if ticket.ticketComment?has_content>
              <div class="ticket-comments text-left">
                ${convertNewLineToHtml(ticket.ticketComment)}
              </div>
            </#if>
    			  </td>
    			  <td><#if ticket.state?? && ticket.state.name??>
    				${ticket.state.name!''}
    				</#if>
    			  </td>
    			  <td>
    				<#if ticket.assigneeUnit??>
            <!-- <p class="text-left"> -->
            <p>
              <strong><i class=" fa fa-sitemap"></i> ${ticket.assigneeUnit.name}</strong>
            </p>
            </#if>
    				<#if ticket.assigneeUser??>
              <!-- <p class="text-left"> -->
              <p>
    				  <#if adminAvatar>
                <img class="direct-chat-img" src="servlet/plugins/adminavatar/avatar?id_user=${ticket.assigneeUser.adminUserId}" alt="" title="Avatar"></#if>
    				    <span class="avatar-label">${ticket.assigneeUser.firstname} ${ticket.assigneeUser.lastname}</span>
            </p>
            </#if>
    			  </td>
    			</tr>
    			</#list>
    	  </tbody>
      </table>
      <div class="row">
        <div class="col-xs-12 col-sm-offset-8 col-sm-4">
          <@paginationAdmin paginator=paginator combo=1 />
        </div>
      </div>
    <#else>
      <div id="no-content">
       <h2 class="text-muted">Pas de demande &agrave; traiter</h2>
       <img class="img-responsive" src="images/admin/skin/plugins/ticketing/no_content.jpg" alt="" title="">
      </div>
    </#if>
    </div>
  </div>
</div>
</#macro>

<!-- TEMPLATE -->
<div class="gru-wrapper">
  <div id="customer-panel" class="row bg-gru-light">
    <div class="col-xs-12 col-sm-offset-1 col-sm-6">
      <h2>#i18n{ticketing.create_ticket.pageTitle}</h2>
      <h3>Les sollicitations</h3>
    </div>
    <div class="col-xs-12 col-sm-1">
      <#if ticket_creation_right?? && ticket_creation_right>
        <form method="post" class="form" name="manage_tickets" action="jsp/admin/plugins/ticketing/ManageTickets.jsp">
          <h2>
          <button name="view_createTicket" type="submit" class="btn btn-border bg-gru-light">
            <i class="fa fa-plus"></i> <span>#i18n{ticketing.manage_tickets.buttonAdd}</span>
          </button>
        </h2>
        </form>
      </#if>
    </div>
  </div>
  <div id="demand-panel" class="row bg-gru-light tickets">
    <div class="col-xs-12 col-sm-12">
    <ul class="nav nav-tabs nav-ticket">
      <li role="presentation" <#if !selected_tab?? || ( selected_tab?? && selected_tab=="agent")> class="active" </#if> >
        <a href="#" onclick="setSelectedTab('agent')" aria-controls="agent" role="tab" data-toggle="tab">
          <i class="fa fa-inbox"></i> Mes demandes <span class="badge">${nb_ticket_agent}</span>
        </a>
      </li>
      <li role="presentation" <#if selected_tab?? && selected_tab == "group"> class="active" </#if> >
        <a href="#" onclick="setSelectedTab('group')" aria-controls="group" role="tab" data-toggle="tab">
          <i class="fa fa-users"></i> Mon &eacute;quipe <span class="badge">${nb_ticket_group!}</span>
        </a>
      </li>
      <li role="presentation" <#if selected_tab?? && selected_tab == "domain"> class="active" </#if> >
        <a href="#" onclick="setSelectedTab('domain')"  aria-controls="domain" role="tab" data-toggle="tab" >
          <i class="fa fa-tags"></i> Mon domaine <span class="badge">${nb_ticket_domain!}</span>
        </a>
      </li>
    </ul>
    <div class="tab-content">
    	<div id="filter-ticket" class="row">
        <form id="filter_form" class="form-inline" action="jsp/admin/plugins/ticketing/ManageTickets.jsp">
          <input type="hidden" name="submitted_form" value="1">
          <input type="hidden" name="fltr_urgency" value="${ticket_filter.urgency!}">
          <input type="hidden" name="selected_tab" value="<#if selected_tab?? && selected_tab?has_content>${selected_tab}<#else>agent</#if>">
          <input type="hidden" name="fltr_order_sort" value="${ticket_filter.orderSort!}">
          <input type="hidden" name="fltr_order_by" value="${ticket_filter.orderBy!}">
    			<div class="col-xs-12 col-sm-offset-1 col-sm-3">
            <button type="submit" name="fltr_new_urgency" value="-1" class="btn btn-link btn-xs <#if ticket_filter.urgency==-1>btn-primary border-gru<#else>border-gru text-gru</#if>">#i18n{ticketing.manage_tickets.urgency.all}</button>
    				<button type="submit" name="fltr_new_urgency" value="2" class="btn btn-link btn-xs <#if ticket_filter.urgency==2>btn-danger<#else>border-red text-red</#if>">#i18n{ticketing.manage_tickets.urgency.high}</button>
    				<button type="submit" name="fltr_new_urgency" value="1" class="btn btn-link btn-xs <#if ticket_filter.urgency==1>btn-warning<#else>border-orange text-orange</#if>">#i18n{ticketing.manage_tickets.urgency.medium}</button>
    				<button type="submit" name="fltr_new_urgency" value="0" class="btn btn-link btn-xs <#if ticket_filter.urgency==0>btn-info<#else>border-info text-aqua</#if>">#i18n{ticketing.manage_tickets.urgency.low}</button>
    			</div>
    			<div class="col-xs-12 col-sm-4">
    				<!-- span class="hidden-xs hidden-sm">#i18n{ticketing.manage_tickets.sortBy} :</span -->
    				<label class="select" for="nature">
    					<@comboWithParams name="fltr_id_type" default_value="${ticket_filter.idType}" additionalParameters=" id=\"fltr_id_type\" class=\"form-control input-xs\" " items=type_list />
    				</label>
            <!--
    				<label class="select" for="domaine">
    					<@comboWithParams name="fltr_id_domain" default_value="${ticket_filter.idDomain}" additionalParameters=" id=\"fltr_id_domain\" class=\"form-control input-xs\" " items=domain_list/>
    				</label>
          -->
    				<label class="select" for="since">
    					<@comboWithParams name="fltr_open_since" default_value="${ticket_filter.openSincePeriod}" additionalParameters=" id=\"fltr_open_since\" class=\"form-control input-xs\" " items=period_list/>
    				</label>
    				</div>
    	</form>
          <div class="col-xs-8 col-sm-4">
            <form class="form-inline" method="post" action="jsp/admin/plugins/ticketing/TicketSearch.jsp?action=search&page_index=1">
          		<input type="hidden" id="searched_field" name="searched_field" value="contents">
              <div class="input-group">
                <label class="sr-only">#i18n{ticketing.manage_tickets.searchDefaultTxt}</label>
          		  <input class="form-control input-xs" type="text" name="query" placeholder="#i18n{ticketing.manage_tickets.searchDefaultTxt}" value="">
                <div class="input-group-btn">
                  <button class="btn btn-primary btn-xs" type="submit" >
          			    <span class="fa fa-search"></span>
          		    </button>
                </div>
              </div>
          	</form>
          </div>
        </div>
        <@notification infos=infos />
        <#if !selected_tab?? || ( selected_tab?? && selected_tab=="agent") >
        	<@renderTabPanel panel_list=ticket_list active=true id='agent' />
        <#else>
        	<@renderTabPanel panel_list="" active=false  id='agent' />
        </#if>
        <#if selected_tab?? && selected_tab=="group" >
        	<@renderTabPanel panel_list=ticket_list  active=true id='group' />
        <#else>
        	<@renderTabPanel panel_list="" active=false  id='group' />
        </#if>
        <#if selected_tab?? && selected_tab=="domain" >
        	<@renderTabPanel panel_list=ticket_list active=true id='domain' />
        <#else>
        	<@renderTabPanel panel_list="" active=false id='domain' />
        </#if>
      </div>
    </div>
  </div>
</div>

<script>
$( function(){
  $(".content-header").toggle();
	// Set link on whole tr
	$("tbody > tr ").on( 'click', function(e){
		//only for ticket lines not for table header
		if ( $(this).attr("data-url") != undefined ){
		    var form = $('<form>', 
		    	{ 'action':$(this).attr("data-url"),
		    	'method':'post'}
	       );
	       form.appendTo('body');
	       form.submit().remove();
	    }
	});

  // Recharge la page

  // Tooltip
  $('[data-toggle="tooltip"]').tooltip();

  // Order Management
  // Init Order
  var sort_order = $("input[name=fltr_order_sort]").val();
  var sort_field = $("input[name=fltr_order_by]").val()=="" ? 'th[data-field="date_create"]' : 'th[data-field="' + $("input[name=fltr_order_by]").val() + '"]';
  $(sort_field).addClass( "th-sort-" + sort_order )

  // Column order
  $("th").on( 'click', function( e ){
    var field = $(this).attr('data-field');
    var order = sort_order=="asc" ? "desc" : "asc";
    sortList( field, order);
  });

  function sortList(field, order){
    	$("input[name=fltr_order_sort]").val(order);
    	$("input[name=fltr_order_by]").val(field);
    	$("#filter_form").submit( );
    }

  $("#fltr_id_type").on( 'change', function(e){
		$("#fltr_id_domain").val( -1 );
		$("#filter_form").submit( );
	});

  $("#fltr_id_domain").on( 'change', function(e){
		$("#filter_form").submit( );
	});

  $("#fltr_open_since").on( 'change', function(e){
		$("#filter_form").submit( );
	});
});

function setSelectedTab(tab){
	$("input[name=selected_tab]").val(tab);
	$("#filter_form").submit( );
}
</script>
